<!DOCTYPE html>
<html>
<head>
  <title>Cilaos le Jeu</title>
  <meta charset="UTF-8">
  <style>
  html, body {
    height: 100%;
    margin: 0;
  }

  body {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  canvas {
    border: 1px solid black;
  }
  </style>
</head>
<body>
<canvas width="667" height="375" id="game"></canvas>
<script>
const canvas = document.getElementById('game');
const context = canvas.getContext('2d');

let end = false;
let menu = false;

let turn = 0;
let phase = 0;//0 pioche, 1 main, 2 plateau

let cards = [
  {type:0, decription:"", name:"Lentilles", pt:1, ability:0},
  {type:0, decription:"", name:"Vin de Cilaos", pt:2, ability:-1},
  {type:0, decription:"", name:"Eau de Cilaos", pt:3, ability:-1},
  {type:0, decription:"", name:"Jours de Cilaos", pt:4, ability:-1},
  {type:1, decription:"", name:"Notre Dame\ndes Neiges", pt:5, ability:-1},
  {type:1, decription:"", name:"Thermes", pt:1, ability:1},
  {type:1, decription:"", name:"Mare à Jonc", pt:2, ability:-1},
  {type:1, decription:"", name:"Musée", pt:3, ability:-1},
  {type:2, decription:"", name:"Route des 400\nvirages", pt:4, ability:-1},
  {type:2, decription:"", name:"Un air pur", pt:5, ability:-1},
  {type:2, decription:"", name:"Départ du Piton\ndes Neiges", pt:1, ability:2},
  {type:2, decription:"", name:"Le Grand Raid", pt:2, ability:-1},
  {type:3, decription:"", name:"Le canyoning", pt:3, ability:-1},
  {type:3, decription:"", name:"L'escalade", pt:4, ability:-1},
  {type:3, decription:"", name:"La randonnée", pt:5, ability:-1},
  {type:3, decription:"", name:"Le VTT", pt:1, ability:3},
  {type:4, decription:"", name:"Tsilaos", pt:2, ability:-1},
  {type:4, decription:"", name:"Les premiers\nhabitants", pt:3, ability:-1},
  {type:4, decription:"", name:"Le Porteur de Vie", pt:4, ability:-1},
  {type:4, decription:"", name:"Tsilaosa", pt:5, ability:-1}
];

let player = {pt:0, hand:[], board:[]};
let opponent = {pt:0, hand:[], board:[]};

for (let i = 0; i < 9; i++) {
  let a = Math.floor(Math.random() * 20);
  let b = Math.floor(Math.random() * 20);
  player.hand.push(cards[a]);
  opponent.hand.push(cards[b]);
}

let card = new Image();
card.src = "card.png"
// let backgroundImage = new Image();
// backgroundImage.src = "background.png"


function drawSplit(str, posx, posy, height) {
  let toWrite = str.split('\n');
  for (let i = 0; i < toWrite.length; i++)
    context.fillText(toWrite[i], posx, posy + i * height);
}

function drawCard(c, posx, posy, scalex, scaley)
{
  let size = 0;
  context.drawImage(card, card.width / 7, 0, card.width / 7, card.height, posx, posy, scalex, scaley);
  context.drawImage(card, card.width / 7 * (c.type + 2), 0, card.width / 7, card.height, posx, posy, scalex, scaley);
  if (scalex == (card.width / 7) / 3)
    size = 15;
  else
    size = 5;
  context.font = size + "px Arial";
  context.fillStyle = 'white';
  context.textAlign = "left";
  context.fillText(c.pt, posx + scalex * 0.9, posy + scaley * 0.07);
  context.fillStyle = 'black';
  context.textAlign = "center";
  drawSplit(c.name, posx + scalex * 0.5, posy + scaley * 0.05, size);
}

function pickCard(j) {
  let a = Math.floor(Math.random() * 20);
  j.hand.push(cards[a]);
}

function doublePoint(j, c) {
  let nb = 0;

  j.board.forEach(function(bc) {
    if (bc.type == j.hand[c].type)
      nb++;
  });
  if (nb >= 3)
    j.pt *= 2;
}

function plusThree(j) {
  let nb = j.board.length - 2;

  if (nb >= 0)
    j.board[nb].pt += 3;
  j.pt += 3;
}

function nullifie(j) {
  let nb = j.board.length - 2;

  if (nb >= 0)
    j.board[nb].type = -1;
}

function playCard(j, op, c) {
  let pt = j.hand[c].pt;

  for (let i = 0; i < j.board.length; i++) {
    if (j.board[i].type == j.hand[c].type) {
      pt *= 2;
      break;
    }
  }
  j.pt += pt;
  j.board.push(j.hand[c]);
  if (j.hand[c].ability != -1) {
    let a = j.hand[c].ability;
    if (a == 0)
      doublePoint(j, c);
    else if (a == 1)
      plusThree(j);
    else if (a == 2)
      op.pt = (op.pt < 4) ? 0 : op.pt - 4;
    else
      nullifie(op);
  }
  j.hand.pop(c);
}

function greed(j) {
  let res = 0;
  for (let i = 1; i < j.hand.length; i++)
    if (j.hand[i].pt > j.hand[res].pt)
      res = i;
  return res;
}

function loop() {
  requestAnimationFrame(loop);
  context.clearRect(0,0,canvas.width,canvas.height);
  // context.drawImage(backgroundImage, 0, 0, 320, 480, 0, 0, canvas.width, canvas.height);

  // if (menu) {
  //   context.textAlign = "center";
  //   context.font = "40px Arial";
  //   context.fillText("Tap to play", canvas.width / 2, canvas.height / 2);
  //} else if (!end) {
      // context.drawImage(image, tile.valueX * imW + frameSize * currentFrame, tile.valueY * imH, imW, imH, tile.x, tile.y, selectionW, selectionH);
      if (turn == 5)
        end = true;
      if (phase == 0)
        context.drawImage(card, 0, 0, card.width / 7, card.height, canvas.width / 2 - ((card.width / 7) / 3) / 2, canvas.height / 2 - ((card.height) / 3) / 2, (card.width / 7) / 3, (card.height) / 3);
      if (phase == 1)
        drawCard(player.hand[player.hand.length - 1], canvas.width / 2 - ((card.width / 7) / 3) / 2, canvas.height / 2 - ((card.height) / 3) / 2, (card.width / 7) / 3, (card.height) / 3);
  // } else {
  //   context.textAlign = "center";
  //   context.font = "40px Arial";
  //   if (player.pt > ia.pt)
  //     context.fillText("Victoire !", canvas.width / 2, canvas.height / 2 - 40);
  //   else if (player.pt < ia.pt)
  //     context.fillText("Défaite...", canvas.width / 2, canvas.height / 2 - 40);
  //   else
  //     context.fillText("Match nul.", canvas.width / 2, canvas.height / 2 - 40);
  //   context.font = "20px Arial";
  //   context.fillText("tap to restart", canvas.width / 2, canvas.height - 10);
  // }
}

// setInterval(increment, 1000);

document.addEventListener('click', function(e) {
  let relativeX = e.x - canvas.offsetLeft;
  let relativeY = e.y - canvas.offsetTop;

  if (!end && !menu) {
    if (phase == 0) {
      pickCard(player);
      pickCard(opponent);
      phase++;
    }
    return;
  } else if (menu) {
    menu = false;
    return;
  } else {
    end = false;
    menu = true;
  }
 });

requestAnimationFrame(loop);
</script>
</body>
</html>