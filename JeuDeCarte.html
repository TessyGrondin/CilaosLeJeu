<!DOCTYPE html>
<html>
<head>
  <title>Cilaos le Jeu</title>
  <meta charset="UTF-8">
  <style>
  html, body {
    height: 100%;
    margin: 0;
  }

  body {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  canvas {
    border: 1px solid black;
  }
  </style>
</head>
<body>
<canvas width="670" height="375" id="game"></canvas>
<script>
const canvas = document.getElementById('game');
const context = canvas.getContext('2d');

let end = false;
let menu = false;

let turn = 0;
let phase = 0;
let handMode = 1;

let slide = false;
let yPick = 375 / 2 - (896 / 3) / 2;

let cards = [
  {type:0, decription:"", name:"Lentilles", pt:1, ability:0},
  {type:0, decription:"", name:"Vin de Cilaos", pt:2, ability:-1},
  {type:0, decription:"", name:"Eau de Cilaos", pt:3, ability:-1},
  {type:0, decription:"", name:"Jours de Cilaos", pt:4, ability:-1},
  {type:1, decription:"", name:"Notre Dame\ndes Neiges", pt:5, ability:-1},
  {type:1, decription:"", name:"Thermes", pt:1, ability:1},
  {type:1, decription:"", name:"Mare à Jonc", pt:2, ability:-1},
  {type:1, decription:"", name:"Musée", pt:3, ability:-1},
  {type:2, decription:"", name:"Route des 400\nvirages", pt:4, ability:-1},
  {type:2, decription:"", name:"Un air pur", pt:5, ability:-1},
  {type:2, decription:"", name:"Départ du Piton\ndes Neiges", pt:1, ability:2},
  {type:2, decription:"", name:"Le Grand Raid", pt:2, ability:-1},
  {type:3, decription:"", name:"Le canyoning", pt:3, ability:-1},
  {type:3, decription:"", name:"L'escalade", pt:4, ability:-1},
  {type:3, decription:"", name:"La randonnée", pt:5, ability:-1},
  {type:3, decription:"", name:"Le VTT", pt:1, ability:3},
  {type:4, decription:"", name:"Tsilaos", pt:2, ability:-1},
  {type:4, decription:"", name:"Les premiers\nhabitants", pt:3, ability:-1},
  {type:4, decription:"", name:"Le Porteur\nde Vie", pt:4, ability:-1},
  {type:4, decription:"", name:"Tsilaosa", pt:5, ability:-1}
];

let player = {pt:0, hand:[], board:[]};
let opponent = {pt:0, hand:[], board:[]};

let highlight = -1;
let crossFrame = 0;
let crossTime = 0;
let choseFrame = 0;
let choseTime = 0;
let buttonFrame = 0;
let buttonTime = 0;

for (let i = 0; i < 9; i++) {
  let a = Math.floor(Math.random() * 20);
  let b = Math.floor(Math.random() * 20);
  player.hand.push({type:cards[a].type, decription:cards[a].decription, name:cards[a].name, pt:cards[a].pt, ability:cards[a].ability});
  opponent.hand.push({type:cards[b].type, decription:cards[b].decription, name:cards[b].name, pt:cards[b].pt, ability:cards[b].ability});
}

let card = new Image();
card.src = "card.png"
let shadow = new Image();
shadow.src = "shadow.png"
let cross = new Image();
cross.src = "cross.png"
let chose = new Image();
chose.src = "chose.png"
let buttonHandPhase = new Image();
buttonHandPhase.src = "buttonHandPhase.png"
// let backgroundImage = new Image();
// backgroundImage.src = "background.png"


function drawSplit(str, posx, posy, height) {
  let toWrite = str.split('\n');
  for (let i = 0; i < toWrite.length; i++)
    context.fillText(toWrite[i], posx, posy + i * height);
}

function drawCard(c, posx, posy, scalex, scaley, tsize)
{
  context.drawImage(card, card.width / 7, 0, card.width / 7, card.height, posx, posy, scalex, scaley);
  context.drawImage(card, card.width / 7 * (c.type + 2), 0, card.width / 7, card.height, posx, posy, scalex, scaley);
  context.font = tsize + "px Arial";
  context.fillStyle = 'white';
  context.textAlign = "left";
  context.fillText(c.pt, posx + scalex * 0.9, posy + scaley * 0.07);
  context.fillStyle = 'black';
  context.textAlign = "center";
  drawSplit(c.name, posx + scalex * 0.5, posy + scaley * 0.05, tsize);
}

function pickCard(j) {
  let a = Math.floor(Math.random() * 20);
  j.hand.push({type:cards[a].type, decription:cards[a].decription, name:cards[a].name, pt:cards[a].pt, ability:cards[a].ability});
}

function doublePoint(j, c) {
  let nb = 0;

  j.board.forEach(function(bc) {
    if (bc.type == j.hand[c].type)
      nb++;
  });
  if (nb >= 3)
    j.pt *= 2;
}

function plusThree(j) {
  let nb = j.board.length - 2;

  if (nb >= 0)
    j.board[nb].pt += 3;
  j.pt += 3;
}

function nullifie(j) {
  let nb = j.board.length - 2;

  if (nb >= 0)
    j.board[nb].type = -1;
}

function playCard(j, op, c) {
  let pt = j.hand[c].pt;

  for (let i = 0; i < j.board.length; i++) {
    if (j.board[i].type == j.hand[c].type) {
      pt *= 2;
      break;
    }
  }
  j.pt += pt;
  j.board.push(j.hand[c]);
  if (j.hand[c].ability != -1) {
    let a = j.hand[c].ability;
    if (a == 0)
      doublePoint(j, c);
    else if (a == 1)
      plusThree(j);
    else if (a == 2)
      op.pt = (op.pt < 4) ? 0 : op.pt - 4;
    else
      nullifie(op);
  }
  j.hand.pop(c);
}

function greed(j) {
  let res = 0;
  for (let i = 1; i < j.hand.length; i++)
    if (j.hand[i].pt > j.hand[res].pt)
      res = i;
  return res;
}

function loop() {
  requestAnimationFrame(loop);
  context.clearRect(0,0,canvas.width,canvas.height);
  // context.drawImage(backgroundImage, 0, 0, 320, 480, 0, 0, canvas.width, canvas.height);

  // if (menu) {
  //   context.textAlign = "center";
  //   context.font = "40px Arial";
  //   context.fillText("Tap to play", canvas.width / 2, canvas.height / 2);
  //} else if (!end) {
      // context.drawImage(image, tile.valueX * imW + frameSize * currentFrame, tile.valueY * imH, imW, imH, tile.x, tile.y, selectionW, selectionH);
      if (turn == 5)
        end = true;
      if (phase == 0)
        context.drawImage(card, 0, 0, card.width / 7, card.height, canvas.width / 2 - ((card.width / 7) / 3) / 2, canvas.height / 2 - ((card.height) / 3) / 2, (card.width / 7) / 3, (card.height) / 3);
      if (phase == 1)
        drawCard(player.hand[player.hand.length - 1], canvas.width / 2 - ((card.width / 7) / 3) / 2, yPick, (card.width / 7) / 3, card.height / 3, 15);
      if (phase == 2) {
        let cx = 0;
        if (handMode == 0) {
          for (let i = 0; i < player.hand.length; i++) {
            drawCard(player.hand[i], cx, 150, canvas.width /10, card.height / 7.5, 7)
            cx += canvas.width / 10;
          }
          if (highlight != -1) {
            context.drawImage(shadow, 0, 0, shadow.width, shadow.height, 0, 0, canvas.width, canvas.height);
            context.drawImage(cross, crossFrame * cross.width / 2, 0, cross.width / 2, cross.height, canvas.width - cross.width / 2, 0, cross.width / 2, cross.height);
            context.drawImage(chose, choseFrame * chose.width / 2, 0, chose.width / 2, chose.height, canvas.width - chose.width / 2, canvas.height - chose.height, chose.width / 2, chose.height);
            drawCard(player.hand[highlight], canvas.width / 2 - ((card.width / 7) / 3) / 2, yPick, (card.width / 7) / 3, card.height / 3, 15);
          } else
            context.drawImage(buttonHandPhase, buttonFrame * buttonHandPhase.width / 4 + handMode * buttonHandPhase.width / 2, 0, buttonHandPhase.width / 4, buttonHandPhase.height, canvas.width - (buttonHandPhase.width / 4 / 2), canvas.height - (buttonHandPhase.height / 2), buttonHandPhase.width / 4 / 2, buttonHandPhase.height / 2);
        } else {
          for (let i = 0; i < player.board.length; i++) {
            drawCard(player.board[i], cx, 200, canvas.width /10 * 1.5, card.height / 7.5 * 1.5, 10)
            cx += canvas.width / 10 * 1.5;
          }
          cx = canvas.width - canvas.width / 10 * 1.5;
          for (let i = 0; i < opponent.board.length; i++) {
            drawCard(opponent.board[i], cx, 0, canvas.width /10 * 1.5, card.height / 7.5 * 1.5, 10)
            cx -= canvas.width / 10 * 1.5;
          }
          context.drawImage(buttonHandPhase, buttonFrame * buttonHandPhase.width / 4 + handMode * buttonHandPhase.width / 2, 0, buttonHandPhase.width / 4, buttonHandPhase.height, canvas.width - (buttonHandPhase.width / 4 / 2), canvas.height - (buttonHandPhase.height / 2), buttonHandPhase.width / 4 / 2, buttonHandPhase.height / 2);
        }
      }
  // } else {
  //   context.textAlign = "center";
  //   context.font = "40px Arial";
  //   if (player.pt > ia.pt)
  //     context.fillText("Victoire !", canvas.width / 2, canvas.height / 2 - 40);
  //   else if (player.pt < ia.pt)
  //     context.fillText("Défaite...", canvas.width / 2, canvas.height / 2 - 40);
  //   else
  //     context.fillText("Match nul.", canvas.width / 2, canvas.height / 2 - 40);
  //   context.font = "20px Arial";
  //   context.fillText("tap to restart", canvas.width / 2, canvas.height - 10);
  // }
}

// setInterval(increment, 1000);

document.addEventListener('click', function(e) {
  let relativeX = e.x - canvas.offsetLeft;
  let relativeY = e.y - canvas.offsetTop;

  if (!end && !menu) {
    if (phase == 0) {
      pickCard(player);
      pickCard(opponent);
      phase++;
    } else if (phase == 1 && !slide)
      slide = true;
    else if (phase == 2) {
      if (highlight != -1 && (relativeX >= canvas.width - cross.width / 2 && relativeY >= 0 && relativeX < canvas.width && relativeY < cross.height))
        crossFrame = 1;
      if (highlight != -1 && (relativeX >= canvas.width - chose.width / 2 && relativeY >= canvas.height - chose.height && relativeX < canvas.width && relativeY < canvas.height))
        choseFrame = 1;
      if (relativeX >= canvas.width - (buttonHandPhase.width / 4 / 2) && relativeY >= canvas.height - (buttonHandPhase.height / 2) && relativeX < canvas.width && relativeY < canvas.height)
        buttonFrame = 1;
      else {
        for (let i = 0; i < player.hand.length; i++) {
          if ((relativeX >= i * 67 && relativeY >= 150 && relativeX < (i + 1) * 67 && relativeY < 150 + card.height / 7.5)) {
            highlight = i;
            break;
          }
        }
      }
    }
    return;
  } else if (menu) {
    menu = false;
    return;
  } else {
    end = false;
    menu = true;
  }
 });

function slideToBottom() {
  if (slide)
    yPick+=3;
  if (yPick >= canvas.height) {
    yPick = canvas.height / 2 - ((card.height) / 3) / 2;
    phase++;
    slide = false;
  }
}

function closeCloseUp() {
  if (crossFrame == 0)
    return;
  if (crossTime > 0) {
    highlight = -1;
    crossFrame = 0;
    crossTime = 0;
  }
  crossTime++;
}

function selectCard() {
  if (choseFrame == 0)
    return;
  if (choseTime > 0) {
    playCard(player, opponent, highlight);
    let i = greed(opponent);
    playCard(opponent, player, i);
    highlight = -1;
    choseFrame = 0;
    choseTime = 0;
    // phase++;
  }
  choseTime++;
}

function switchMode() {
  if (buttonFrame == 0)
    return;
  if (buttonTime > 0) {
    handMode = (handMode == 0) ? 1 : 0;
    buttonFrame = 0;
    buttonTime = 0;
  }
  buttonTime++;
}

setInterval(slideToBottom, 1);
setInterval(closeCloseUp, 50);
setInterval(selectCard, 50);
setInterval(switchMode, 50);

requestAnimationFrame(loop);
</script>
</body>
</html>